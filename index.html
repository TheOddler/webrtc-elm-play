<html>
    <head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Pablo's Spel</title>
	</head>
    <body>
        <style>
            #outgoing {
            width: 600px;
            word-wrap: break-word;
            }
        </style>

        <form>
            <textarea id="incoming"></textarea>
            <button type="submit">submit</button>
        </form>
        <pre id="outgoing"></pre>

        <div id="main"></div>

		<script src="simplepeer.min.js" type="text/javascript"></script>
        <script src="main.js" type="text/javascript"></script>
        <script type="text/javascript">
            // Create elm
            var node = document.getElementById('main');
            var app = Elm.Main.embed(node);

            // Start WebRTC
            var p = new SimplePeer({ initiator: location.hash === '#1', trickle: false });
            p.on('error', function (err) { console.log('error', err) });
            p.on('signal', function (data) {
                console.log('SIGNAL', JSON.stringify(data))
                document.querySelector('#outgoing').textContent = JSON.stringify(data)
            });
            document.querySelector('form').addEventListener('submit', function (ev) {
                ev.preventDefault()
                p.signal(JSON.parse(document.querySelector('#incoming').value))
            });

            // Connect WebRTC and Elm
            app.ports.send.subscribe(function(message) {
                console.log("Sending: " + message);
                p.send(message)
            });
            p.on('connect', function () {
                console.log('CONNECT');
                if (location.hash === '#1') {
                    p.send("Hey, I'm the initiator, how is it going?")
                }
                else {
                    p.send("Hey, I'm the receiver, how are you doing?")
                }
            });
            p.on('data', function (data) {
                console.log('got a message: ' + data);
                app.ports.listen.send("" + data);
            });
		</script>
    </body>
</html>